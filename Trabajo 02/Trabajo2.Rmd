---
title: |
  \includegraphics[width=25cm]{EscudoUN.png}  
  \thispagestyle{empty} 
  \vspace*{2.0cm} 
  \textbf{\huge Título del trabajo \\Materia}  
  \vspace{5.07cm}
author: |
 |  \Large \textbf{Daniela Arbeláez Montoya}
 |  \Large \textbf{Jefferson Gamboa Betancur}
 |  \Large \textbf{Jean Paul Piedrahita García}
 |  \vspace{5cm}
date: |
  | \small Universidad Nacional de Colombia
  | Ciencias, Escuela de Estadística
  | Medellín, Colombia
  | 2021
documentclass: article
geometry: 
  - top=2cm
  - left=1.8cm
  - right=2cm
  - bottom=2.54cm
fontsize: 12pt
pagestyle: empty
papersize: a4
linestretch: 1.5
linkcolor: blue
links-as-notes: true
lang: "es"
header-includes:
- \usepackage[utf8]{inputenc}
- \setlength{\parindent}{0pt}
- \usepackage{graphicx}
- \pagenumbering{gobble}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{hyperref}
output: 
    pdf_document: 
      toc: yes
      number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  cache = TRUE,
  message = FALSE,
  error = FALSE,
  warning = FALSE,
  tidy = TRUE,
  tidy.opts=list(width.cutoff = 55),
  prompt = TRUE
  )
options(kableExtra.latex.load_packages = FALSE)
require(kableExtra)
```

```{=tex}
\newpage
\pagenumbering{arabic}
\setcounter{page}{2}
\pagestyle{plain}
```
```{r}
ITabla <- function(M){
  kbl(M, booktabs = T) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
}
```

# Introducción

California es uno de los lugares que tiene las temporadas de incendios forestales más mortíferas y destructivas. El conjunto de datos contiene la lista de incendios forestales ocurridos en California entre 2013 y 2020; contiene la ubicación donde ocurrieron los incendios forestales, incluido el nombre del condado, los valores de latitud y longitud y también detalles sobre cuándo comenzó el incendio forestal.

Estos datos ayudan a generar información sobre qué lugares de California están bajo amenaza de incendio, a qué hora suelen ocurrir los incendios forestales y qué tan frecuentes y devastadores son.

La base de datos con la que se va realizar el análisis de patrones puntuales fue descargada de [kaggle](https://www.kaggle.com/ananthu017/california-wildfire-incidents-20132020).

Los paquetes a utilizar son los siguientes: 

```{r}
library(spatstat)
library(sf)
library(raster)
library(rgdal)
library(tidyverse)
library(maps)
```

# Análisis descriptivo

Para leer el archivo se utiliza la función *"read_csv"* de la librería *"tidyverse"* y se visualiza la dimensión de la base de datos con la función *"dim"*.

```{r}
firesCA <- read_csv(file = "https://raw.githubusercontent.com/JeffGB94/Estadistica_Espacial/main/Trabajo%2002/Base/California_Fire_Incidents.csv")

M <- as.data.frame(t(dim(firesCA)))
names(M) <- c("Filas", "Columnas")
ITabla(M)
```

Todos los incendios forestales registrados en la base de datos se encuentran inactivos o han sido contenidos. Debido a la gran cantidad de variables, seleccionamos algunas para visualizar un poco mejor las localizaciones de incendios, tales como:

- **AcresBurned:** representa el número de acres de tierra afectadas por los incendios forestales.

- **ArchiveYear:** año en el cual se desarrolló o se produjo el incendio forestal.

- **Name:** nombre o denominación asignada al incendio forestal.

- **Counties:** nombre del condado en el cual se produjo el incendio forestal.

- **Latitude** y **Longitude** corresponden a las coordenadas geográficas de cada uno de los incendios forestales

```{r}
# Selección de variables
firesCA <- firesCA %>% select(AcresBurned, ArchiveYear, Name, 
                              Counties, Latitude, Longitude)
```

```{r, echo=FALSE}
M <- as.data.frame(head(firesCA))
ITabla(M)
```

Para saber el número de incendios que ocurrieron por año, visualizamos el número de registros con la función **table**. Se puede observar que el año 2017 fue el periodo donde más hubo incendios.

```{r, echo = FALSE}
# ¿Cuántos incendios ocurrieron en cada año?
M <- as.data.frame((table(firesCA$ArchiveYear)))
names(M) <- c("Año", "Freq")
ITabla(M)
```

Se desea entonces observar y analizar el patrón de puntos de incendios forestales ocurridos durante el año 2017 en el estado de California. De esta manera realizamos el filtro correspondiente por año de ocurrencia y además, eliminamos aquellas observaciones con errores en sus coordenadas geográficas:

```{r}
# Seleccionando el año 2017
firesCA2017 <- firesCA %>% filter(ArchiveYear == 2017, Longitude != 0, Latitude != 0)
```

Sin embargo, la base de datos sigue registrando seis observaciones duplicadas de acuerdo a sus coordenadas geográficas. Eliminamos dichas observaciones de la siguiente manera:

```{r, echo=TRUE}
# ¿Hay datos duplicados?: 6 por valores de longitud y latitud
sum(duplicated(firesCA2017 %>% select(Longitude, Latitude)))
firesCA2017 <- firesCA2017[!duplicated(firesCA2017 %>% select(Longitude, Latitude)),]
```

La función **project** del paquete **rgdal** ofrece una interfaz con la librería *PROJ.4* de funciones de proyección para datos de posición geográfica. Para poder utilizar esta función debemos extraer las coordenadas de cada uno de los incendios en una matriz. Realizamos la proyección correspondiente de acuerdo a la zona UTM en la cual se encuentra el estado de California y de acuerdo al elipsoide **WGS84** (Sistema Geodésico Mundial).  

```{r, echo = TRUE}
# Seleccionando las coordenadas
coordFiresCA2017 <- firesCA2017 %>% select(Longitude, Latitude) %>% as.matrix()
# Proyección de coordenadas a UTM
pointsFiresCA2017 <- project(coordFiresCA2017, "+proj=utm +zone=11N +ellps=WGS84") %>% 
  as.data.frame() %>% rename(X = Longitude, Y = Latitude)
```

```{r, echo=FALSE}
pointsFiresCA2017 <- pointsFiresCA2017 %>% filter(!is.infinite(X))
```

## Contorno de California

El paquete **maps** contiene la base de datos **state** que produce un mapa de los estados del territorio continental de los Estados Unidos generado a partir de los datos del Departamento del Censo del mismo país; estos datos contiene las coordenadas geográficas de los polígonos correspondientes a cada uno de los estados.  

```{r}
# Base de datos de Estados Unidos
UnitedStates <- map_data("state")
# ¿Qué estados?
names(table(UnitedStates$region))
```

Realizamos el flitro correspondiente al estado de California para obtener el polígono. La función **map_data** del paquete **ggplot2** convierte fácilmente los datos del paquete de **maps** en un marco de datos adecuado para trazar con **ggplot2**. La opción **Mercator** indica meridianos rectos igualmente espaciados, concordantes y rumbos rectos de la brújula.

```{r}
# Filtramos para California
California <- UnitedStates %>% filter(region == "california")
ggplot(California, aes(x=long, y=lat)) +
  geom_polygon(fill="white", colour="black") + coord_map("mercator") +
  labs(title = "Estado de California en proyección Mercator",
       x = "Longitud", y = "Latitud") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 12))
```

```{r, echo=FALSE}
rm(UnitedStates)
```

De la misma manera realizamos la proyección de las coordenadas geográficas en planas de acuerdo a la zona UTM correspondiente al estado de California. 

```{r}
# Coordenadas del borde para proyección
coordCA_border <- California %>% select(long, lat) %>% as.matrix()
coordCA_border <- project(coordCA_border, "+proj=utm +zone=11N +ellps=WGS84") %>% 
  as.data.frame() %>% rename(X = long, Y = lat)
```

Luego de la proyección, podemos crear el objeto **owin** corresponndiente a la ventana de observación para el análisis del patrón de puntos espacial; sin embargo, es posible que algunos puntos o incendios forestales recaigan fuera de dicha ventana de observación, algo que no sería acorde o adecuado para el análisis. Para solucionar este inconveniente utilizamos la función **inside.owin** de la siguiente manera:

```{r}
# Creación del objeto owin a partir del borde
contpolyCA <- owin(poly = data.frame(x = rev(coordCA_border$X), y = rev(coordCA_border$Y)))

# ¿Cómo eliminar los puntos que están fuera del contorno?
ok <- inside.owin(x = pointsFiresCA2017$X, y = pointsFiresCA2017$Y, w = contpolyCA)
pointsFiresCA2017 <- data.frame(X = pointsFiresCA2017$X[ok], Y = pointsFiresCA2017$Y[ok])
# Creación del objeto ppp a partir del patrón de puntos
FiresCA2017_ppp <- ppp(x = pointsFiresCA2017$X, y = pointsFiresCA2017$Y, window = contpolyCA)
```

Visualizamos la proyección de los puntos en nuestra ventana de observación

```{r}
ggplot(data = coordCA_border, aes(x = X, y = Y)) + 
  geom_polygon(fill = "white", color = "black") +
  geom_point(data = pointsFiresCA2017, aes(x = X, y = Y), color = "red") +
  labs(title = "Localización de Incendios en California, año 2017") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 12))
```

# Procesos puntuales

## Análisis basado en densidad

## Densidad cuadrática

El siguiente fragmento de código divide el estado de California en una cuadricula 9 filas, 6 columnas y luego se hace el conteo de las localizaciones que caen en cada cuadrante.

```{r}
Q <- quadratcount(FiresCA2017_ppp)
plot(FiresCA2017_ppp, pch = 20, main = "Conteo por cuadrantes", cols = "#00000088")
plot(Q, col = 2, add = TRUE)
```

Se puede calcular la densidad de puntos dentro de cada cuadrante pero cada cuadrante esta en metros cuadrados, por ello para una visualización numérica se decidió pasar las localizaciones en $km^2$ de la siguiente manera:

```{r, echo = TRUE}
# Reescalamiento a kilometros
FiresCA2017_ppp.km <- rescale(FiresCA2017_ppp, 1000, "km")

# Conteo por cuadrantes en km
Q <- quadratcount(FiresCA2017_ppp.km)
# Intensidad
Q.d <- density(FiresCA2017_ppp.km)

par(mfrow = c(1,2), no.readonly = T)
# plot de la densidad
plot(intensity(Q, image = T), main = "Densidad de incendios forestales \n en California", 
     las = 1)
plot(FiresCA2017_ppp.km, pch = 20, cex = 0.6, col = rgb(0,0,0,.5), add = T, cols = "#00000088")
# Intensidad estimada
plot(Q.d, main = "Intensidad Estimada")
contour(Q.d, add = T)
```
La intensidad espacial estimada para los incendios en California en el año 2017, proporciona una idea de lo que podemos esperar que pase en esa misma región en un futuro no muy lejano.

```{r}
persp(Q.d, main = "Superficie para la intensidad de incendios 2017", theta = -50, phi = 30, shade = 0.75, ticktype = "detailed", xlab = "x", ylab = "y", zlab = "", cex.axis = 0.7, cex.lab = 0.7)
```







